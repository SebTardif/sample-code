

---
apiVersion: v1
kind: Secret
metadata:
  name: twistlock-secrets
  namespace: twistlock
type: Opaque
data:
  service-parameter: cmhFX04yOExMWDFWNGNpSW4wbVhWTWNrMkNjSl81blRlVmUyYWxGWDhWcDllLWpTRGtwUWVweHpnaUpRMzBEb2JaRURKQmhhOHlBRWROQXBZUlBPUlE9PQ==
  ca.pem: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvVENDQWVXZ0F3SUJBZ0lRQ1FKdkpSVUwzZTdWSnNsTFgxeXQxREFOQmdrcWhraUc5dzBCQVFzRkFEQW8KTVJJd0VBWURWUVFLRXdsVWQybHpkR3h2WTJzeEVqQVFCZ05WQkFNVENWUjNhWE4wYkc5amF6QWVGdzB4T0RBNQpNakl4TlRVd01EQmFGdzB5TVRBNU1qRXhOVFV3TURCYU1DZ3hFakFRQmdOVkJBb1RDVlIzYVhOMGJHOWphekVTCk1CQUdBMVVFQXhNSlZIZHBjM1JzYjJOck1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0MKQVFFQTJGRUVPK3N4VUIxS3RydHdtVHE0WnRzUjlSNGRoMDQ3SzhSd2VtaTVVQ2dzc2g4WTFpVkRXSUdjQkwzcApMQWJtN2pXTUVyM3hZVTNORmJzdnZlV05Hd25oV0tRbzJSbDlUU3RoMmtqb0VxV2IxUzA3Q0RWL0lQamJBNlZ2CnQybkd4S0tYcXhyZjJwamM4Rnl6RllWQjFPWlpPK2FXV3hOTG1Xckxic3RtVDVHaWFNOHR3UEdKdlFFRkY3MlYKTnJSREFGdGkrMDFVdXNabVJoQTNlZUIzRWwrQjc3eXZveWNNY01rbDZOVW5WZk1BUVJpbDFuTDB2Q1Z3QnJNTQp3a1BkdHNKY3JmYkwzUTQ5WnpKK0pvY1hYeThsek1yUDE4QlRLL212Wm1aQzlFVDIrUHBQekQ3d1N3ZDFnbENMCk5Kcjl0NDNnc3lOYVBYNEwvOFh4T0tYaTVRSURBUUFCb3lNd0lUQU9CZ05WSFE4QkFmOEVCQU1DQXF3d0R3WUQKVlIwVEFRSC9CQVV3QXdFQi96QU5CZ2txaGtpRzl3MEJBUXNGQUFPQ0FRRUFWeUZYTlEwbnA5enNQNUI1dGNSVApjdHI3ekFGeGtoWjRpRjk3a3hoUVFGZmlGakxFKzZHY3BVY2hQZzNRanBndUtjb3luWGgxTE8yUGhKWldwb1ZECkM5RUdVeDNmaFFDb2xabmp3czJpa004TXMrNzVKSzdTcW43Z3hsUkxWY2RWWktYQjAzOU1IYmx2RkhPZ2poeEIKbitYbWdENHM5K2R2YmdxcFdKZ3FVbHBObXBkUXNMMXV5RzZiNzR5dWxERmhqUnJQRVFBdlhMaXZ5QXY5bm5EZQpGVUJld01hbUI5SzE0L2dHemZCWWZhV3pHdTk3WTB5WnpCUDFLTDVrbXNjYVFtWExnclJ6NERvaVJHdy8rQXRzCkg3QTBSOUxUYjFCbGgwZGtnbmJuVU5JcTRaNE5JK2ZKT1lqNk9uVkhCTXhLVGdwR2xxQlkvZ285eU40cmpORE0KVnc9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  client-cert.pem: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURHakNDQWdLZ0F3SUJBZ0lRWkFLV1czUURRR01hWlJQUTdobkgvREFOQmdrcWhraUc5dzBCQVFzRkFEQW8KTVJJd0VBWURWUVFLRXdsVWQybHpkR3h2WTJzeEVqQVFCZ05WQkFNVENWUjNhWE4wYkc5amF6QWVGdzB4T0RBNQpNakl4TlRVd01EQmFGdzB5TVRBNU1qRXhOVFV3TURCYU1DZ3hFakFRQmdOVkJBb1RDVlIzYVhOMGJHOWphekVTCk1CQUdBMVVFQXhNSmJHOWpZV3hvYjNOME1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0MKQVFFQXkwQUVPMHM2bjZPY3YzL0diN1dWSzZjYmFkOXdIa1h3bzdRNnlDZ0crSGRpMTBaTzRLLzhCU3U3Mjk2VApJZ2o3dFB2aC9wVlNveTJ6K3RzMTMrSm9rT0RlZ0tIVmp6dXY4MWVSOVZuSUlLdUtYM2lTUmtETWthTHRaRTd0Ck9yaVI5MzU2T2RoWDY1ODBONFpCR3llL2kxQzRzcTNmUGZRNDBRQzNqa0lPdy9FTkRXUmQrOEJDQWJLQzdHUC8KbG03VXkxQkRCTjRUYXR2Y0N0RXlkYzJkZWEvbm81L29TZElRZlpwTmNnNUdyc05pekpHcUIydDNjRVpwMWtsRgp5Tlc5cXRYcmt6dVFvSVZrSXNYa2tpN0ZMZzVYQ0wwR2w4YTB6TlRaZzVTZDNyRGNLUEx5aVB3VnBUbC8xVVg1ClQxSGsxc1NEcnRKdEZ2eG5OZmtib21tbzJ3SURBUUFCbzBBd1BqQU9CZ05WSFE4QkFmOEVCQU1DQjRBd0V3WUQKVlIwbEJBd3dDZ1lJS3dZQkJRVUhBd0l3REFZRFZSMFRBUUgvQkFJd0FEQUpCZ1VxQkFFQ0J3UUFNQTBHQ1NxRwpTSWIzRFFFQkN3VUFBNElCQVFCTjZRbUxHS3hEd3FiOFpKaGZQdnVqMWJXOWVKeXlYNDhXNXg2THJKODZSeS91CkN6RHVVMDhVNy9vNXFocDZBdjFuT3BTOENxWXNWU2FBN3hxdkNrbnRxZXBpVERENFpyVGJvVjlCSFRscGkrM3cKNU5LSFdKUy9CT2t0a0tBVjdNcTQ5blhLbnM4RC9DQlZEZDRvN0Y1S1E3cUVtcnJrc0VacThPOXp2a0FOSnBPKworZGJVNFNUQ1dqdXVkcktUdEx3dDJOY0Y2dDdBV2xDeE9lanlYS0lhQjJNYnZsRTR0cDRnaUJwV0RMdGJEQkJjCkh0a2NrQnV6YWN6SlJnMlNOSnd6cVJOTWw2bXBTY1BMUWRnbEpKUlQ5dmd2SFZhS3R4SUFhS1J3Ryt3SzI0RXkKMmZHSm9Pb1EzU1U5Y3dWSTQzMnRLTnF1MkhteVBLYkl4SGlkL0FJMwotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  client-key.pem: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpQcm9jLVR5cGU6IDQsRU5DUllQVEVECkRFSy1JbmZvOiBBRVMtMjU2LUNCQyxjNmY3YTQ4ZGI2NmFhNDBjYzQ5ZTRmZmFiZTM5NTg5NgoKUm45NDU4eC9ZdzQrZWFWc3Q5eHprSmh0VVdndVBPM1JTOUxmck1LN3oyRzVXL0I4QjllYWUvekNvbWwzY2o4Ngpna0pYUlhuaUozcC9samNEU0RDd0ZhMCtYamtsZGpnMUNFT0ttSjhDM085OHNkbnhwa25senovbDJ6TjZ4S2VWCjhzcHRXZlBnMjNmMlVjYWVUeXdlNkwvQ1paTDhWNWVLcUVzOVFJcmFzN3V6UXhKbytOUlQvdFlETHVqNGJvSHcKZ016VCthbkNCNWs0c1NsYmJ3UlhjbGp5WC85V2E2QndPSTArM3k2eGI3VnlHaW92cTNBVnp4ajlPUUIvWnROVAo4aVVNMWlTRUNwRWphSTk1bUoxa2kwSS83QUx3K1ltNXhlekNiK2pKbFFha21adm90M2lVUG4zaEl3amVIUVJQCnk4SXAzUE1PeENEUDcrSHJQcXZSZjBCTTVGNWozTnpRcEpxRDJadUpNRnFheTU3R3pDelArSUl5bjVadHdPWWMKUEQxOW5zWG5LSUFWMnZyNjR5TmhTVUd4NzdtWjJiV3h5WGx5WXNZRzkxMU9UVy9ZSDNXWmtmMWVSbmRlemdNegpxckVZZ0RXRXJpdnZCbGpETmViTVBmeDd4eFZwdzZVdVpCeHpYNnpmVCtXZTdCQXh3UnNHUE5QaTE4djNtSGQ1CmcxSDh6RGJxeldIWUI2bFBSOXdveDlFS1JqOU10VktHZXlVY0JObmFGeDZPa0ZhbXpYYzUxaldXTGVybVo3YmIKTnUrTndnL1F4N0NDT24zRzl6bWd6c2w2ZS8zZlhsd1ZSNkc3OWdueWRIUzFMMkhDR3RJVU9jbnAzbWc4QVhtMQprZ1JadGNKYmZHL2VRUmQwdUNtZWhBVHJWeHp6TUZreElVN3lRMk1CdUIxYkZwMjNkS3RGV29jbW8rNXNONVhzCnJlcm43YTQzRUVlNGFTTTluWGRORXJnVnpJVmswbTNvQlBqMldZZmIwSTgySEtRU1dndlRaQXdvblZ4MHJjcHkKYVhzMnRWVHJLSTFLMWJLY0gwSkRsdUhCSExTbTh2ajdra21ITm1pZ2NRdU4rSjFVdExXbTV1bDNDK2JEcEsyYwpDcThzcTlsaStvRHNZRElUdWVlOHc2MEtQaDBiVTc4N1l6TmhoYzVkaXB3Ym1DK3RrTUgwK2tRYlduYXRtTlp5Ckx6dFYwTnRYWGVGcDFQVEhKOS9rSXNzUkxzOUNJVWNlTUFhVVY1MGhray8xT1E2eXgybWZGNTJUYWd2VG9IM2QKU0E1WWRwaUJNbkhnRjkyb0l1b0pFTndMWmRUT09qd2lzL1JsT2JVNzRUYnBkbDFBYW1IVktwaGcxbGhUMFdRTwpmS1dXY0lJMlZhOURhTUNkNnlRNms2eExBRkpVMmIzYUd3OGhiVS95b3d1b3VRc1hpZHN6RXMvTk9DRjZoVGJqCnkxVkMrcm9kUUk3VVZtNlZ0ODRSSVdFMVpGSVZPWkYydmxNcG1QUHVBd0liOFVOaFFPSWNVSHFWRy9xTlh5ZXoKMU1pOVNWdDZUZ2lCeitjcTZ5dnk1eWtJalQzdVloV1NqNXdWZ1ZSVEdhREcxTlBQdTNDQ0R6YkFZK1pBem1OaQpCZUl5Z3phZDJLWnRYUWxCMzBWRVBWYWI2SDdaalEwUmJ1LzZXVUU5dWptWWxpYXlKYWRsOUYzNkhmZ2VoeHJlCkRxWE00cDhOVTVtdG9CVHcvanZwdXhDb01nY2c3bzlFYWZ2YVlEbzZ6bGN0YmF2bFhQYzZaY0NmU1NIVThUWjcKWjJ3SWxCNDhxQ2NMT3pmMU5aM3l2VkZDdENOa0JGSUF4SC9NcWhKSzJDQXl4c1lub3FiY0d5OXhIUWYxNW1hSwovSDlKT1pDNmJMRlF3NHVSdmo4QzFpQTZZeDhxZUhwVkhzbFFLbkpKdW5VaUVjUklkeWZxcytrQWFSQTV0VzkyCjFNdjJpSUcxWXFWWFhHbm81cmx6Qzcwanp5K2MrOFZtTlNZNmVTSktRUFh2dlBmZEtLc0R1RUdGbHNHWVlSaHEKeURDYWxoUGtvNTJmM2hwUkNpelZ4UWVKWFhvUHhSMnQ3Zk50VG52NTNjcktiUFZNdXhzZ3BrVDQ1UGV1NmVQawotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=

---
apiVersion: v1
kind: ServiceAccount # Service Account is used for managing security context constraints policies in Openshift (SCC)
metadata:
  name: twistlock-service
  namespace: twistlock
secrets:
- name: twistlock-secrets
---
apiVersion: extensions/v1beta1 # Daemonset is still not part of v1 api version
kind: DaemonSet
metadata:
  name: twistlock-defender-ds
  namespace: twistlock
spec:
  template:
    metadata:
      labels:
        app: twistlock-defender
    spec:
      serviceAccountName: twistlock-service
      
      restartPolicy: Always
      containers:
      - name: twistlock-defender25121
        image: registry-auth.twistlock.com/tw_4owb1xf69xrrxq8zlsfxhc3mnzqjxr4b/twistlock/defender:defender_2_5_121
        volumeMounts:
        - name: data-folder
          mountPath: "/var/lib/twistlock"
        - name: certificates # Setting the certificates mount after data-folder since it is nested and was overridden in CRI based GKE cluster
          mountPath: "/var/lib/twistlock/certificates"
        - name: docker-sock-folder
          mountPath: "/var/run"
        - name: passwd
          mountPath: "/etc/passwd"
          readOnly: true
        - name: docker-netns
          mountPath: "/var/run/docker/netns"
          readOnly: true
        - name: syslog-socket
          mountPath: "/dev/log"
        - name: auditd-log
          mountPath: "/var/log/audit"
        
        - name: iptables-lock
          mountPath: "/run"
        env:
        - name: WS_ADDRESS
          value: wss://35.232.104.170:8084
        - name: HTTP_PROXY
          value: ""
        - name: NO_PROXY
          value: ""
        - name: DEFENDER_TYPE
          value: daemonset
        - name: DEFENDER_LISTENER_TYPE
          value: "none"
        - name: LOG_PROD
          value: "true"
        - name: SYSTEMD_ENABLED
          value: "false"
        - name: DOCKER_CLIENT_ADDRESS
          value: "/var/run/docker.sock"
        securityContext:
          readOnlyRootFilesystem: true
          privileged: false
          
            
          capabilities:
            add:
            - NET_ADMIN  # NET_ADMIN - Required for process monitoring
            - SYS_ADMIN  # SYS_ADMIN - Required for filesystem monitoring
            - SYS_PTRACE # SYS_PTRACE - Required for local audit monitoring
            - AUDIT_CONTROL # AUDIT_CONTROL - required for system calls monitoring
        resources: # See: https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/#how-pods-with-resource-requests-are-scheduled
          limits:
            memory: 512M
          requests:
            cpu: 256m
      volumes:
      - name: certificates
        secret:
          secretName: twistlock-secrets
          defaultMode: 256
      - name: syslog-socket
        hostPath:
          path: "/dev/log"
      - name: data-folder
        hostPath:
          path: "/var/lib/twistlock"
      - name: docker-netns
        hostPath:
          path: "/var/run/docker/netns"
      - name: passwd
        hostPath:
          path: "/etc/passwd"
      - name: docker-sock-folder
        hostPath:
          path: "/var/run"
      - name: auditd-log
        hostPath:
          path: "/var/log/audit"
      
      - name: iptables-lock
        hostPath:
          path: "/run"
      hostPID: true
      hostNetwork: true